# Android Publishing

### Table of Contents

- [Overview](#overview)

- [Configuration](#configuration)
  - [Environment variables](#env-vars)

- [Repositories](#repositories)
  - [Default Maven Local](#maven-local)

  - [Custom Local](#custom-local)

  - [Public Remote](#remote-public)

  - [Private Remote](#remote-private)

- [Gradle Tasks](#tasks)

- [Troubleshooting](#troubleshooting)

<a id="overview"></a>

## Overview

`expo-brownfield-target` enables you to build the brownfield library and its dependencies and publish them to any number of Maven repositories of various types:

- Default `MavenLocal`/`mavenLocal()` repository

- Custom local repositories

- Publicly accessible remote repositories

- Remote repositories with password-based access

Based on the publishing configuration specified in `app.json` / `app.config` file, the plugin generates publishing configuration and registers necessary publish Gradle tasks which you can later invoke using the CLI or manually.

For the manual setup of the publishing please see [manual-setup.md](./manual-setup.md).

<a id="configuration"></a>

## Configuration

Publishing can be configured via `android.publishing` array in `app.json` / `app.config` file:

```json
[
  "expo-brownfield-target",
  {
    "android": {
      "publishing": [
        {
          "type": "localMaven"
        },
        {
          "type": "remotePrivate",
          "url": {
            "variable": "MAVEN_REPO_URL"
          },
          "username": {
            "variable": "MAVEN_REPO_USERNAME"
          },
          "password": {
            "variable": "MAVEN_REPO_PASSWORD"
          },
          "allowInsecure": true
        }
      ]
    },
```

You can specify multiple publishing configurations for each repository type.

If you don't pass the `name` property (accepted by all repositories besides `localMaven`) the names will be automatically generated by suffixing the repository type with next numbers to ensure uniqueness (e.g. `remotePrivate1`, `remotePrivate2`).

If you use custom names ensure that they are unique. Please keep in mind that while Gradle tasks are created the combined parts get capitalized, so e.g. `remotePrivate1` becomes `...RemotePrivate1...`.

Multiple specifications for `localMaven` (MavenLocal) are redundant because this repository can be configured at most once.

If no repository is specified (the `publishing` option is not specified at all) the configuration will default to the default `MavenLocal` repository.

If an empty array is passed no publishing configuration will be generated.

<a id="env-vars"></a>

### Environment variables

The following properties of `remotePrivate` repositories:

- URL
- Username
- Password

Can be specified either as plain strings or as objects to be read from the environment variables (e.g. when provided in the `.env` file at the root of the Expo project):

```json
"url": {
  "variable": "MAVEN_REPO_URL"
},

// Or

"url": "https://localhost:8081/my-private-maven-repo",
```

> [!WARNING]  
> When the values are read from environment variables they will be inserted into android project's `build.gradle` file on prebuild. Watch out to not commit the prebuilt native project to GitHub to avoid leaking those variables.

<a id="repositories"></a>

## Repositories

<a id="maven-local"></a>

### Default Maven Local

Default `MavenLocal`/`mavenLocal()` repository. The location of this repository on the machine (usually `~/.m2/repository/`) is automatically resolved by Maven.

Type:

```ts
type LocalMavenPublication = {
  type: 'localMaven';
};
```

Example:

```json
{
  "type": "localMaven"
}
```

<a id="custom-local"></a>

### Custom Local

A custom directory path. Can be an absolute path or a relative path (resolved against the Expo project root).

Type:

```ts
type LocalDirectoryPublication = {
  type: 'localDirectory';
  name?: string;
  path: string;
};
```

Example:

```json
{
  "type": "localDirectory",
  "name": "customLocal",
  "path": "./maven"
}
```

<a id="remote-public"></a>

### Public Remote

A remote repository without authentication.

Accepts optional `allowInsecure` setting which translates to Maven's [isAllowInsecureProtocol](https://docs.gradle.org/current/kotlin-dsl/gradle/org.gradle.api.artifacts.repositories/-url-artifact-repository/is-allow-insecure-protocol.html) and specifies whether it is possible to communicate with a repository via an insecure connection.

Type:

```ts
type RemotePublicPublication = {
  type: 'remotePublic';
  name?: string;
  url: string;
  allowInsecure?: boolean;
};
```

Example:

```json
{
  "type": "remotePublic",
  "name": "remotePublic",
  "url": "http://localhost:8081/repository/remote-public",
  "allowInsecure": true
}
```

<a id="remote-private"></a>

### Private Remote

A remote repository with password-based authentication.

Accepts optional `allowInsecure` setting which translates to Maven's [isAllowInsecureProtocol](https://docs.gradle.org/current/kotlin-dsl/gradle/org.gradle.api.artifacts.repositories/-url-artifact-repository/is-allow-insecure-protocol.html) and specifies whether it is possible to communicate with a repository via an insecure connection.

Type:

```ts
type EnvValue = {
  variable: string;
};

type RemotePrivateBasicPublication = {
  type: 'remotePrivate';
  name?: string;
  url: string | EnvValue;
  username: string | EnvValue;
  password: string | EnvValue;
  allowInsecure?: boolean;
};
```

Example:

```json
{
  "type": "remotePrivate",
  "url": {
    "variable": "MAVEN_REPO_URL"
  },
  "username": {
    "variable": "MAVEN_REPO_USERNAME"
  },
  "password": {
    "variable": "MAVEN_REPO_PASSWORD"
  }
}
```

<a id="tasks"></a>

## Gradle Tasks

Each publishing configuration is mapped to three tasks for `Debug`, `Release` and `All` configurations. So, for example following configuration:

```json
{
  "type": "localDirectory",
  "name": "customLocal",
  "path": "./maven"
}
```

Results in:

```
publishBrownfieldAllPublicationToCustomLocalRepository

publishBrownfieldDebugPublicationToCustomLocalRepository

publishBrownfieldReleasePublicationToCustomLocalRepository
```

Which you can invoke using the CLI or manually using `./gradlew`. To view all available publishing tasks run:

```
npx expo-brownfield-target tasks-android
```

Or list them manually:

```
./gradlew <brownfield-library-name>:tasks --group publishing | grep  publishBrownfield
```

For full reference of the CLI and `tasks-android` command please see [cli.md](./cli.md).

<a id="troubleshooting"></a>

## Troubleshooting

### No publishing configuration is generated

**Solution:** Ensure that you haven't passed an empty array for the `android.publishing` option as it results in no repositories being configured. Make sure that you have run `npx expo prebuild` after updating the configuration to apply the changes to the native project.

### The updates made to the artifacts aren't reflected in the Maven repository

**Solution:** Only some Maven repositories support publishing new versions of the artifacts without changing the versions. The publishing tasks and CLI don't cover removing the already existing artifacts from the repositories.

### The artifacts can't be published to my remote repository

**Solution:** Ensure that the credentials are correct and provided via environment variables (if you are sourcing them from there). If your repository is hosted via unsafe network protocol be sure to include `allowInsecure` set to `true` option in the configuration.

### My authentication method is not supported by the library

**Solution:** We currently only support the password-based authentication. If your repository requires other way of authentication which can be configured from Gradle feel free to open an issue or start a discussion with the feature request.
